// backend/models/associations.js
const { sequelize } = require('../config/database');
const { DataTypes } = require('sequelize');

// Define all models directly here to avoid function format issues
const User = sequelize.define('User', {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  name: { type: DataTypes.STRING(100), allowNull: false },
  email: { type: DataTypes.STRING(100), allowNull: false, unique: true, validate: { isEmail: true } },
  password: { type: DataTypes.STRING(255), allowNull: false },
  role: { type: DataTypes.ENUM('admin', 'customer'), defaultValue: 'customer' },
  phone: { type: DataTypes.STRING(20), allowNull: true },
  profile_image: { type: DataTypes.STRING, allowNull: true, defaultValue: null },
  first_name: { type: DataTypes.STRING, allowNull: true },
  last_name: { type: DataTypes.STRING, allowNull: true },
  address: { type: DataTypes.TEXT, allowNull: true }
}, {
  tableName: 'users',
  timestamps: true,
  underscored: true
});

const Product = sequelize.define('Product', {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  name: { type: DataTypes.STRING, allowNull: false },
  price: { type: DataTypes.DECIMAL(10, 2), allowNull: false },
  stock: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 0 },
  description: { type: DataTypes.TEXT, allowNull: true },
  image_url: { type: DataTypes.STRING, allowNull: true },
  category_id: { type: DataTypes.INTEGER, allowNull: false },
  slug: { type: DataTypes.STRING, allowNull: true },
  is_featured: { type: DataTypes.BOOLEAN, defaultValue: false }
}, {
  tableName: 'products',
  timestamps: true,
  underscored: true
});

const Category = sequelize.define('Category', {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  name: { type: DataTypes.STRING, allowNull: false },
  description: { type: DataTypes.TEXT, allowNull: true },
  slug: { type: DataTypes.STRING, allowNull: true }
}, {
  tableName: 'categories',
  timestamps: true,
  underscored: true
});

const Cart = sequelize.define('Cart', {
  id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
  user_id: { type: DataTypes.INTEGER, allowNull: false },
  product_id: { type: DataTypes.INTEGER, allowNull: false },
  quantity: { type: DataTypes.INTEGER, allowNull: false, defaultValue: 1, validate: { min: 1 } }
}, {
  tableName: 'cart',
  timestamps: true,
  underscored: true,
  indexes: [
    { unique: true, fields: ['user_id', 'product_id'] }
  ]
});

// Optional Order models
let Order, OrderItem;
try {
  Order = sequelize.define('Order', {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    user_id: { type: DataTypes.INTEGER, allowNull: false },
    total_amount: { type: DataTypes.DECIMAL(10, 2), allowNull: false },
    status: { type: DataTypes.ENUM('pending', 'processing', 'shipped', 'completed', 'cancelled'), defaultValue: 'pending' },
    payment_method: { type: DataTypes.STRING, allowNull: true },
    payment_status: { type: DataTypes.ENUM('pending', 'completed', 'failed'), defaultValue: 'pending' },
    shipping_address: { type: DataTypes.TEXT, allowNull: true },
    shipping_cost: { type: DataTypes.DECIMAL(10, 2), defaultValue: 0 },
    notes: { type: DataTypes.TEXT, allowNull: true }
  }, {
    tableName: 'orders',
    timestamps: true,
    underscored: true
  });

  OrderItem = sequelize.define('OrderItem', {
    id: { type: DataTypes.INTEGER, primaryKey: true, autoIncrement: true },
    order_id: { type: DataTypes.INTEGER, allowNull: false },
    product_id: { type: DataTypes.INTEGER, allowNull: false },
    quantity: { type: DataTypes.INTEGER, allowNull: false },
    price: { type: DataTypes.DECIMAL(10, 2), allowNull: false },
    total: { type: DataTypes.DECIMAL(10, 2), allowNull: false }
  }, {
    tableName: 'order_items',
    timestamps: true,
    underscored: true
  });
  
  console.log('Order models created');
} catch (e) {
  console.warn('Order models creation skipped:', e.message);
}

// Set up all associations
console.log('Setting up associations...');

// Product <-> Category associations
Product.belongsTo(Category, { 
  foreignKey: 'category_id',
  as: 'Category'
});

Category.hasMany(Product, { 
  foreignKey: 'category_id',
  as: 'Products'
});

// Cart associations
Cart.belongsTo(User, { 
  foreignKey: 'user_id',
  as: 'User'
});

Cart.belongsTo(Product, { 
  foreignKey: 'product_id',
  as: 'Product'
});

User.hasMany(Cart, { 
  foreignKey: 'user_id',
  as: 'CartItems'
});

Product.hasMany(Cart, { 
  foreignKey: 'product_id',
  as: 'CartItems'
});

// Order associations (if Order exists)
if (Order) {
  User.hasMany(Order, { 
    foreignKey: 'user_id',
    as: 'Orders'
  });

  Order.belongsTo(User, { 
    foreignKey: 'user_id',
    as: 'User'
  });

  if (OrderItem) {
    Order.hasMany(OrderItem, {
      foreignKey: 'order_id',
      as: 'OrderItems'
    });

    OrderItem.belongsTo(Order, {
      foreignKey: 'order_id',
      as: 'Order'
    });

    OrderItem.belongsTo(Product, { 
      foreignKey: 'product_id',
      as: 'Product'
    });

    Product.hasMany(OrderItem, { 
      foreignKey: 'product_id',
      as: 'OrderItems'
    });
  }
}

// Add bcrypt method to User
const bcrypt = require('bcryptjs');
User.prototype.matchPassword = async function(enteredPassword) {
  return await bcrypt.compare(enteredPassword, this.password);
};

console.log('âœ… All models and associations loaded');

module.exports = {
  User,
  Product,
  Category,
  Cart,
  Order,
  OrderItem
};